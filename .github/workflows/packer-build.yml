name: Build Windows 11 Packer Image

on:
    push:
        branches:
            - main
        paths:
            - "packer/**"
            - ".github/workflows/packer-build.yml"
    pull_request:
        branches:
            - main
        paths:
            - "packer/**"
    workflow_dispatch:
        inputs:
            debug_enabled:
                description: "Enable debug logging"
                required: false
                default: false
                type: boolean

permissions:
    id-token: write
    contents: read

env:
    PACKER_VERSION: "1.15.0"

jobs:
    validate:
        runs-on: ubuntu-latest
        name: Validate Packer Configuration
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Packer
              uses: hashicorp/setup-packer@v3
              with:
                  version: ${{ env.PACKER_VERSION }}

            - name: Packer Init
              run: packer init packer/packer.pkr.hcl

            - name: Packer Format Check
              run: packer fmt -check packer/

            - name: Packer Validate
              #env:
                  #ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
                  #ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
                  #ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
              run: packer validate packer/packer.pkr.hcl

    build:
        runs-on: ubuntu-latest
        name: Build Packer Image
        needs: validate
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Packer
              uses: hashicorp/setup-packer@v3
              with:
                  version: ${{ env.PACKER_VERSION }}

            - name: Azure Login (Federated)
              uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3.0
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
                  enable-AzPSSession: true

            - name: Packer Init
              run: packer init packer/packer.pkr.hcl

            - name: Build Image with Packer
              run: |
                  packer build packer/packer.pkr.hcl

            - name: Extract managed image id from packer manifest
              id: extract_image
              run: |
                  # Look for packer manifest in the workflow root or the packer/ subdirectory
                  if [ -f packer-manifest.json ]; then
                    MANIFEST="packer-manifest.json"
                  elif [ -f packer/packer-manifest.json ]; then
                    MANIFEST="packer/packer-manifest.json"
                  else
                    echo "packer-manifest.json not found in root or packer/"
                    ls -la
                    exit 1
                  fi
                  echo "Using manifest: $MANIFEST"
                  IMAGE_ID=$(jq -r '.builds[].artifact_id' "$MANIFEST" | grep -o 'managed_image_id=[^ ]*' | sed 's/managed_image_id=//')
                  if [ -z "$IMAGE_ID" ]; then
                    echo "Failed to extract managed image id from $MANIFEST"
                    cat "$MANIFEST"
                    exit 1
                  fi
                  echo "managed_image_id=$IMAGE_ID" >> $GITHUB_OUTPUT
                  echo "manifest_path=$MANIFEST" >> $GITHUB_OUTPUT

            - name: Publish managed image to Shared Image Gallery
              if: steps.extract_image.outputs.managed_image_id != ''
              env:
                  IMAGE_ID: ${{ steps.extract_image.outputs.managed_image_id }}
              run: |
                  set -e
                  VERSION="1.0.${{ github.run_number }}"
                  echo "Publishing managed image $IMAGE_ID to Shared Image Gallery as version $VERSION"
                  az sig image-version create \
                    --resource-group rg-whitefam-image-gallery \
                    --gallery-name sig_whitefam_gallery \
                    --gallery-image-definition win11-pro \
                    --gallery-image-version $VERSION \
                    --managed-image "$IMAGE_ID" \
                    --target-regions name=uksouth

            - name: Upload Build Logs
              if: always()
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                  name: packer-build-logs
                  path: |
                      crash.log
                      packer-manifest.json
                      packer/packer-manifest.json

            - name: Notify Success
              if: success()
              run: |
                  echo "âœ… Packer image build completed successfully!"
                  echo "Managed image published to Shared Image Gallery (if enabled)."
                  echo "See artifact logs for details"
